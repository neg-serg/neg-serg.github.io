---
layout: post
title: Мой форк Notion wm
categories: personal
tags: 
  - notion
  - fork
  - compton
  - dzen2
comments: true
mathjax: null
featured: true
published: true
---

# Введение

Ion3 задумывался как тайловый оконный менеджер "новой волны", по сравнению со
своими более простыми и минималистичными предшественниками, такики как LarsWM,
и породил собой целую новую категорию оконных менеджеров для X11, никто из
которых, тем не менее, несмотря на то что ион был один из первых, так и не
повторил полностью заложенную в него на момент закрытия проекта
функциональность. Например Split View, который появился в последних версиях OS
X не поддерживает табы, куда более прост, так же как и все другие реализации,
для любой среды и ОС, такие как встроенные в kwin, а также всякие i3,
herbstluftwm и другие.

Но всё же чем рассказывать про него лучше попробовать самому или посмотреть на
видео в интернете, потому что слова мало что передают в плане ощущений от
работы. Как уже рассказывал в предыдущей статье ion3 был закрыт и на его
месте появился более или менее жизнеспособный форк, под названием Notion.
Вот его основные отличия по сравнению с ионом:

* Исправлен баг обработки события XConfigureRequestEvent, который перемещал
  диалоговые окна в неправильное место. <a
  href="https://sourceforge.net/tracker/?func=detail&aid=3167262&group_id=314802&atid=1324528">(#3167262)</a>
* Добавление опции 'lazy_resize' для свойств(winprop) окна, которая нужна для
  приложений, которые медленно меняют свой размер. Суть в том, что существовало
  два вида изменения размера, это с помощью рамки и с динамическим
  обновлением(как обычно) окна. Данная опция в реальном времени позволяет
  изменять размер только видимого окна. То есть если в одном фрейме более
  одного окна, то в реальном времени будет изменяться размер только одного из
  них, что сильно ускоряет процесс.
* EMWH: добавлено кодирование _NET_WM_NAME как UTF8_STRING
* EMWH: добавлена поддержка _NET_ACTIVE_WINDOW
* EMWH: исправлена ошибка в обработке _NET_WM_USER_TIME, которая не давала
  новым окнам получить фокус <a
  href="https://sourceforge.net/tracker/?func=detail&aid=3109576&group_id=314802&atid=1324528">(#3109576)</a>
* Исправлены ошибки в неправильном подсчете и бесконечных циклах для ширины табов.
* mod_xinerama: изменения в экранной топологии теперь учитываются без перезапуска Notion.
* mod_xinerama: поддержка перекрывающихся экранов.
* Добавлено mod_xkbevents, для работы с раскладкой клавиатуры.
* mod_xrandr: добавлен хук randr_screen_change_notify, который отвечает за изменение параметров экрана.
* Различные улучшения системы сборки, в том числе улучшение детектирования текущей версии lua.
* Проект был переименован в Notion в силу особенностей лицензирования проекта ion3.
* На сайте этого не написано, но была несколько улучшена поддержка utf8.
* Другие мелкие улучшения и правки багов, чтобы посмотреть их можно обратиться
  к репозиторию на гитхабе: <a
  href="https://github.com/raboof/notion">github.com/raboof/notion</a>

Notion создает объектную модель для всех сущностей на экране, которые могут
быть вложены друг в друга. Объектную не в смысле ООП, а в семантическом, проект
написан на си и никакой инкапсуляции и тп. тут нет. Как и асинхронности,
к сожалению, используется xlib. Благодаря этой модели вы можете создавать
скратчпады с табами, "плавающие рабочие столы(workspace, который ведет себя как
окно и много чего странного). Но главное -- это очень удобная лично для меня
поддержка tab'ов как в браузере, при этом полноценная поддержка плавающих окон
и декораций для них. "Скратчпады"(область которая показывется и скрывается по
хоткею) как и любые области тоже могут содержать табы или разбиваться на
фреймы. Благодаря статическому тайлингу вы получаете баланс между контролем
над окнами и автоматическим управлением ими.

# Мой форк

Тем не менее не всё так хорошо как хотелось бы и у иона есть недостатки, от
некоторых из которых я попытался избавиться самостоятельно. Мой форк можно
найти по адресу  <a
href="https://github.com/neg-serg/notion">github.com/neg-serg/notion</a>.

Изменения касались как просто чистки кода от того что больше не нужно и замены
этого кода функциональностью из других программ: например dzen2 вместо
mod_statusbar, <a href="https://github.com/DaveDavenport/rofi">rofi</a> вместо
mod_query и mod_menu, с помощью скриптов(об этом позже), так и некоторыми
вещами, которые связаны с ядром, например:

* Добавлена поддержка xft шрифтов. Поддержка реализована кривовато, через
  препроцессор, так что придется выбирать использовать или растровые шрифты или
  векторные(xft), но не оба типа сразу. <a
  href="https://github.com/neg-serg/notion/commit/3c23d9c18be7bab3a308e2dc258f05cea55121e2">[link]</a>
* Добавлена, или, точнее, возвращена из ion3, существовавшая со старых времен
  ограниченная поддержка композитных расширений. Ограниченная из-за того что
  argb цвета в качестве фона приложения пока не поддерживаются. Короче говоря
  сделать истинную прозрачность такую чтобы фон окна был прозрачный, но только
  он(так называемое true-transparency) пока сделать нельзя. К тому же требуется
  дополнительная поддержка с помощью скриптов. <a
  href="https://github.com/neg-serg/notion/commit/6d77ac848099f344f80bededb436c13d2cb8c743">[link]</a>
* Убраны модули, которыми я не пользуюсь, такие как mod_xinerama -- у меня нет
  мультимониторной конфигурации, mod_query и mod_menu -- вместо них можно
  теперь использовать внешние меню, у меня в скриптах это реализовано через
  rofi, mod_statusbar -- вместо неё используется dzen2, который более красивый
  и позволяет вставлять картинки, рисовать разными шрифтами и использовать
  разные цвета.
* Добавлена поддержка "тегов" для навигации по окнам определенного
  типа(например виртуальным машинам), выставляется в winprops
* Добавлена поддержка скратчпадов, которые похожи на скратчпады в других wm, то
  есть вы просто нажимаете win+f, скажем и получаете не просто область, но ещё
  и запущенное приложение в нем(в данном случае *st ncmpcpp*), если оно не было
  создано ранее.
* При активации скратчпады всегда выходят на первый план, так намного удобнее.
* Мелкие улучшения вроде более коротких псевдонимов для хоткеев(M4 вместо Mod4
  и тп.)

Это всё в результате придает Notion более современный вид, а также уменьшает
размер кодовой базы. В планах, когда я снова займусь его кодом, дальнейшее
упрощение и разнесение функциональности по разным изолированным модулям. Код
оригинального ion3 страшен и непонятен, по крайней мере для меня, а изменения
нужны.

Это о том что касалось ядра, теперь о том что касается конфигурации. Мной были
добавлены скрипты, которые позволяют использовать rofi в качестве меню и dzen2
в качестве панели. Которые более красивые, современные, а что главное, являются
отдельными приложениями, которые никак не связаны с Notion. Также модуль для
поддержки прозрачности и кое-что ещё, вот различные изменения, которые были
сделаны:

* Модуль <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/app.lua">app.lua</a>
  добавлена поддержка тегов
* Модуль <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/named_scratchpad.lua">named_scratchpad.lua</a>
  при активации скратчпадов они всегда выходят на первый план, что позволяет
  сразу их увидеть, странно что. это не было сделано сразу.
* Модуль <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/min_tabs.lua">min_tabs</a>.
  Всегда минимизировать табы. Возможно это не такой уж лучший выход, я ещё
  подумаю.
* Модуль <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/directions.lua">directions</a>.
  Делал не я, позволяет осуществлять навигацию по правающим фреймам по
  направлению от текущего влево, вправо, вверх, вниз.
* Модуль <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/screenshot.lua">screenshot</a>.
  Изначально написан не мной, был улучшен чтобы выводить уведомления о том что
  скриншот снят, другие правила именования и ещё какие-то мелкие улучшения.
* Конфиг <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/cfg_dzen.lua">cfg_dzen</a>,
  который позволяет использовать две dzen panel, которые работали бы так же
  хорошо, как и mod_statusbar.
* Различные меню сделанные через rofi в конфиге <a href="">rofi</a>
* Модуль <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/cfg_autostart.lua">cfg_autostart</a>.
  В настоящий момент отвечает только за запуск rofi, раньше использовался ещё
  и для dzen2, теперь это не нужно.
* Модуль поддержки раскладки клавиатуры mod_xkbevents, я в нем что-то менял, но
  сам не помню что.
* Модуль с различными дополнительными функциями <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/helpers.lua">helpers</a>.
* Модуль, который выставляет прозрачность для пустых фреймов: <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/transparency.lua">transparency</a>
* Модуль для вывода информации в dzen без завешивания процесса Notion -- просто
  так создать поток и использовать его в данном случае не получится, нужно
  использовать lua coroutines <a
  href="https://github.com/neg-serg/dotfiles/blob/master/.notion/dzen_bg.lua">dzen_bg</a>.

Вот как выглядит почти всё вышеперечисленное вместе(скриншот постановочный):
![my_notion_scr](http://i.imgur.com/WgqbnYP.png?1)
